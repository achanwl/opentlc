- name: Get a list of infra nodes
  k8s_info:
    kind: Node
    label_selectors:
      - node-role.kubernetes.io/infra
  register: infranode_list

- name: Remove worker label from infra nodes
  k8s:
    state: present
    merge_type: json
    api_version: v1
    kind: Node
    name: "{{ item }}"
    definition:
      - {"op":"remove", "path":"/metadata/labels/alan.test"}
#     - op: remove
#       path: /metadata/labels/node-role.kubernetes.io\/worker
  with_items: "{{ infranode_list | json_query('resources[].metadata.name') }}"

- name: Create MachineConfigPool infra
  k8s:
    state: present
    definition:
      apiVersion: machineconfiguration.openshift.io/v1
      kind: MachineConfigPool
      metadata:
        name: infra
      spec:
        machineConfigSelector:
          matchExpressions:
            - {key: machineconfiguration.openshift.io/role, operator: In, values: [worker,infra]}
        nodeSelector:
          matchLabels:
            node-role.kubernetes.io/infra: ""

- name: Move routers to infra nodes and scale up to 3
  k8s:
    api_version: operator.openshift.io/v1
    kind: IngressController
    namespace: openshift-ingress-operator
    name: default
    definition:
      spec:
        nodePlacement:
          nodeSelector:
            matchLabels:
              node-role.kubernetes.io/infra: ""
          tolerations:
          - effect: NoSchedule
            key: infra
            value: reserved
          - effect: NoExecute
            key: infra
            value: reserved
        replicas: 3

- name: Move registry to infra nodes
  k8s:
    api_version: imageregistry.operator.openshift.io/v1
    kind: Config
    name: cluster
    definition:
      spec:
        nodeSelector:
          node-role.kubernetes.io/infra: ""
        tolerations:
        - effect: NoSchedule
          key: infra
          value: reserved
        - effect: NoExecute
          key: infra
          value: reserved

